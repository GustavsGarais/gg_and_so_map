<!DOCTYPE html>
<html>
<head>
  <title>Map with Markers from JSON</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
</head>
<body>

<div id="map" style="width: 100%; height: 500px;"></div>

<script>
  // Initialize the map
  var map = L.map('map').setView([57.0, 24.0], 7);

  // Add OpenStreetMap tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Define EPSG:3059 (LKS92) projection
  proj4.defs("EPSG:3059", "+proj=tmerc +lat_0=0 +lon_0=24 +k=0.9996 +x_0=500000 +y_0=-6000000 +datum=WGS84 +units=m +no_defs");

  // Function to convert coordinates from EPSG:3059 to EPSG:4326
  function convertCoordinates(x, y) {
    return proj4("EPSG:3059", "EPSG:4326", [x, y]);
  }

  // Fetch JSON data from the server
  fetch('/data')
    .then(response => response.json())
    .then(features => {
      const markerGroup = L.featureGroup();

      features.forEach(function(feature) {
        var coords = feature.geometry.coordinates;
        var convertedCoords = convertCoordinates(coords[0], coords[1]);
        console.log('Converted Coordinates:', convertedCoords);

        if (convertedCoords[0] >= -90 && convertedCoords[0] <= 90 && convertedCoords[1] >= -180 && convertedCoords[1] <= 180) {
          var marker = L.marker(convertedCoords).bindPopup("<b>" + feature.properties.PLACENAME + "</b><br>District: " + feature.properties.LVM_DISTRI + "<br>Block Key: " + feature.properties.BLOCKKEY);
          markerGroup.addLayer(marker);
        } else {
          console.warn('Invalid coordinates for', feature.properties.PLACENAME, convertedCoords);
        }
      });

      markerGroup.addTo(map);
      map.fitBounds(markerGroup.getBounds());
    })
    .catch(error => console.error('Error loading JSON data:', error));
</script>

</body>
</html>
